---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - supabase/functions/qbo-api/index.ts
autonomous: true

must_haves:
  truths:
    - "Edge Function responds to HTTP requests at /qbo-api/* routes"
    - "CORS allows requests from localhost:5173 and the production frontend URL"
    - "Requests without a valid Supabase JWT get 401 Unauthorized"
    - "The /auth/callback route is excluded from JWT verification (browser redirect, no auth header)"
    - "Unknown routes return structured JSON error, not Hono default HTML"
    - "All QBO API helper functions include minorversion=75 on every request"
  artifacts:
    - path: "supabase/functions/qbo-api/index.ts"
      provides: "Hono-based Edge Function with CORS, auth middleware, error handling, health check"
      min_lines: 80
  key_links:
    - from: "supabase/functions/qbo-api/index.ts"
      to: "jsr:@hono/hono"
      via: "import statement"
      pattern: "from 'jsr:@hono/hono'"
    - from: "supabase/functions/qbo-api/index.ts"
      to: "Deno.serve"
      via: "server bootstrap"
      pattern: "Deno\\.serve\\(app\\.fetch\\)"
    - from: "supabase/functions/qbo-api/index.ts"
      to: "jose"
      via: "JWT verification middleware"
      pattern: "jwtVerify"
---

<objective>
Build the Supabase Edge Function scaffold with Hono routing, CORS middleware, JWT auth middleware, and error handling.

Purpose: This is the single "fat function" that will handle ALL QBO server-side operations. Plan 03 (OAuth flow) and every subsequent phase adds route handlers into this scaffold. Getting the middleware stack right now prevents every future plan from having to deal with CORS, auth, and error handling.

Output: A working Edge Function at supabase/functions/qbo-api/index.ts with Hono routing, CORS, JWT middleware (with auth exclusions for OAuth callback), error handler, health check route, and a QBO fetch helper that enforces minorversion=75.
</objective>

<execution_context>
@C:\Users\Gustavo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Gustavo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Hono Edge Function with middleware stack</name>
  <files>supabase/functions/qbo-api/index.ts</files>
  <action>
Replace the scaffold `supabase/functions/qbo-api/index.ts` (created by `supabase functions new` in Plan 01) with a complete Hono-based Edge Function.

The file must include ALL of the following in this order:

**1. Imports:**
```typescript
import { Hono } from 'jsr:@hono/hono'
import { cors } from 'jsr:@hono/hono/cors'
import { createClient } from 'npm:@supabase/supabase-js@2'
import * as jose from 'npm:jose@^5'
```
Use `jsr:@hono/hono` (NOT `https://deno.land/x/hono` — that is the old import path). Import cors from `jsr:@hono/hono/cors` (NOT `jsr:@hono/hono/middleware` — the cors middleware has its own subpath).

**2. Hono app with basePath:**
```typescript
const app = new Hono().basePath('/qbo-api')
```
CRITICAL: basePath MUST be `/qbo-api` matching the function directory name. Without this, ALL routes 404.

**3. CORS middleware (first middleware):**
Allow origins: `http://localhost:5173` (Vite dev) and `Deno.env.get('QBO_FRONTEND_URL')` (production). Allow methods: GET, POST, OPTIONS. Allow headers: Content-Type, Authorization. Set maxAge: 86400.

**4. JWT auth middleware (second middleware):**
Verify the Supabase JWT from the Authorization header using `jose.jwtVerify()` with the Supabase JWKS endpoint (`${SUPABASE_URL}/auth/v1/.well-known/jwks.json`).

CRITICAL EXCLUSION: The `/auth/callback` route must be EXCLUDED from JWT verification. This route is hit by the user's browser as a redirect from QBO — there is no Authorization header. Check `c.req.path` and skip JWT verification for paths ending in `/auth/callback`.

On successful verification, store the JWT payload on the Hono context (`c.set('jwtPayload', payload)`) so downstream handlers can access it.

On failure, return `{ error: 'Unauthorized', message: 'Invalid or missing JWT' }` with status 401.

**5. Request logging middleware:**
Log to console: method, path, and timestamp for every request. This is viewable in Supabase Edge Function logs dashboard.

**6. Supabase service client helper:**
Create a function `getServiceClient()` that returns a Supabase client using `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` from `Deno.env`. This client is used for Vault access and qbo_connection queries. Cache the client instance — do not create a new one per request.

**7. QBO fetch helper:**
Create a helper function `qboFetch(accessToken: string, path: string, options?: RequestInit)` that:
- Builds the full URL using `Deno.env.get('QBO_BASE_URL')` (defaults to `https://sandbox-quickbooks.api.intuit.com`) + path
- ALWAYS appends `minorversion=75` as a query parameter (MANDATORY per project decision)
- Sets `Authorization: Bearer ${accessToken}` header
- Sets `Accept: application/json` header
- Sets `Content-Type: application/json` for POST/PUT requests
- Returns the fetch response
- Logs the request method, URL, and response status to console

This helper will be used by every future QBO API call (entity sync, purchase creation, etc).

**8. Health check route:**
`GET /health` returns `{ status: 'ok', timestamp: new Date().toISOString() }` with status 200.

**9. Placeholder route comments:**
Add comments marking where Plan 03 will add OAuth routes:
```typescript
// OAuth routes (Plan 01-03)
// app.get('/auth/start', ...)
// app.get('/auth/callback', ...)
// app.get('/connection/status', ...)
```

**10. Global error handler:**
Use Hono's `app.onError()` to catch unhandled exceptions and return:
```json
{ "error": "Internal Server Error", "message": "<error.message in dev, generic in prod>" }
```
with status 500. Log the full error to console.

**11. 404 handler:**
Use Hono's `app.notFound()` to return:
```json
{ "error": "Not Found", "message": "Route not found" }
```
with status 404 (instead of Hono's default HTML response).

**12. Server bootstrap:**
```typescript
Deno.serve(app.fetch)
```
Use `Deno.serve()` (NOT the deprecated `serve` from `https://deno.land/std/http/server.ts`).

IMPORTANT: Do NOT add route handler implementations for OAuth — those are Plan 03's responsibility. This plan only creates the scaffold, middleware, and helper functions.
  </action>
  <verify>
- File exists at `supabase/functions/qbo-api/index.ts`
- Contains `import { Hono } from 'jsr:@hono/hono'` (correct import path)
- Contains `.basePath('/qbo-api')` (prevents 404s)
- Contains CORS middleware with localhost:5173 origin
- Contains JWT verification middleware with `/auth/callback` exclusion
- Contains `qboFetch` helper with `minorversion=75` parameter
- Contains `Deno.serve(app.fetch)` at the end
- Contains `app.onError()` and `app.notFound()` handlers
- Run `npx supabase functions serve qbo-api --no-verify-jwt` locally to confirm it starts without syntax errors (if CLI is authenticated). If not authenticated, verify TypeScript compiles by checking for obvious syntax issues.
  </verify>
  <done>Edge Function scaffold is complete with Hono routing, CORS, JWT auth middleware (with callback exclusion), request logging, service client helper, qboFetch helper enforcing minorversion=75, health check, error/404 handlers, and Deno.serve bootstrap. Ready for Plan 03 to add OAuth route handlers.</done>
</task>

</tasks>

<verification>
1. `supabase/functions/qbo-api/index.ts` is a complete, syntactically valid TypeScript file
2. Uses `jsr:@hono/hono` import (NOT old deno.land path)
3. basePath is `/qbo-api` (matching function directory name)
4. CORS allows localhost:5173 and production URL from env
5. JWT middleware excludes `/auth/callback` path
6. `qboFetch` helper appends `minorversion=75` to every QBO API request
7. Error handler returns JSON (not HTML)
8. Health check route responds at GET /health
9. `Deno.serve(app.fetch)` bootstraps the server
</verification>

<success_criteria>
- Edge Function file is syntactically valid and uses correct Deno/JSR imports
- Middleware stack: CORS -> JWT auth (with exclusions) -> logging
- qboFetch enforces minorversion=75 on all QBO API calls
- Error responses are structured JSON, never HTML
- Health check route works
- OAuth route placeholders marked for Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
