---
phase: 01-foundation
plan: 01-01
subsystem: database-schema
tags: [supabase, postgresql, migrations, vault, rls, edge-functions]
requires: []
provides:
  - supabase/ directory initialized with config.toml
  - expenses table extended with 4 QBO sync columns
  - qbo_connection table with Vault UUID references and RLS
  - Vault extension enabled with 3 SECURITY DEFINER wrapper functions
  - Edge Function scaffold at supabase/functions/qbo-api/index.ts
affects:
  - 01-02: Edge Function scaffold exists for Hono implementation
  - 01-03: qbo_connection table and Vault functions ready for OAuth token storage
  - Phase 2: update_vault_secret function provisioned for token rotation
tech-stack:
  added: [supabase-cli@2.76.9]
  patterns: [SECURITY DEFINER wrapper functions, deny-all RLS, partial index for unsynced queries]
key-files:
  created:
    - supabase/config.toml
    - supabase/functions/qbo-api/index.ts
    - supabase/migrations/20260217000001_expenses_qbo_columns.sql
    - supabase/migrations/20260217000002_qbo_connection.sql
  modified:
    - .gitignore
key-decisions:
  - "db push deferred: supabase link requires SUPABASE_ACCESS_TOKEN or interactive browser login"
  - "update_vault_secret provisioned now for Phase 2 use; no Phase 1 caller expected"
  - "Edge Function scaffold created manually (no supabase functions new) due to CLI auth gate"
duration: 3min
completed: 2026-02-17
---

# Phase 1 Plan 01: Database Schema and Supabase CLI Init Summary

**Supabase CLI initialized, Edge Function scaffold created, and two SQL migrations written for QBO sync columns on expenses table and qbo_connection table with Vault-encrypted token storage references.**

## Performance
- **Duration:** ~3 minutes
- **Started:** 2026-02-17T14:47:39Z
- **Completed:** 2026-02-17T14:49:57Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Supabase CLI init (`supabase init`) completed successfully — `supabase/config.toml` created
- Edge Function scaffold `supabase/functions/qbo-api/index.ts` created with Hono placeholder
- Migration 1 (`20260217000001_expenses_qbo_columns.sql`): Adds 4 QBO columns to expenses table using `ADD COLUMN IF NOT EXISTS` (idempotent, safe for production data)
- Migration 2 (`20260217000002_qbo_connection.sql`): Creates `qbo_connection` table, enables Vault extension, sets up deny-all RLS, creates 3 SECURITY DEFINER wrapper functions
- `.gitignore` updated to exclude `supabase/.env.local` and `supabase/.temp/`

## Task Commits
1. **Task 1: Initialize Supabase CLI and Edge Function scaffold** - `5f878d0` (feat)
2. **Task 2: Create database migrations** - `317fd4d` (feat)

**Plan metadata:** (docs commit below)

## Files Created/Modified
- `supabase/config.toml` - Supabase project configuration (auto-generated by supabase init)
- `supabase/functions/qbo-api/index.ts` - Edge Function scaffold with Hono import placeholder
- `supabase/migrations/20260217000001_expenses_qbo_columns.sql` - Adds qbo_purchase_id, qbo_pushed_at, qbo_error, qbo_sync_attempts to expenses table; partial index for unsynced queries
- `supabase/migrations/20260217000002_qbo_connection.sql` - qbo_connection table, Vault extension, RLS, 3 Vault wrapper functions
- `.gitignore` - Added supabase/.env.local and supabase/.temp/ exclusions

## Decisions Made
- **Deferred supabase link/db push:** The Supabase CLI requires either `SUPABASE_ACCESS_TOKEN` env var or interactive browser login. Neither is available in this execution environment. Migration files are ready to apply; user must run `npx supabase login` then `npx supabase link --project-ref <ref>` then `npx supabase db push`.
- **update_vault_secret provisioned for Phase 2:** The wrapper function is created now so the migration is complete, but no Phase 1 code calls it. Phase 2 token rotation will use it.
- **Edge Function scaffold created manually:** `supabase functions new qbo-api` requires CLI auth. Directory and file were created directly to deliver the same result.

## Deviations from Plan
### Auto-handled Issues

**1. [Rule 3 - Blocking] Supabase CLI login requires interactive auth**

- **Found during:** Task 1
- **Issue:** `npx supabase login` fails in non-TTY environment with "Cannot use automatic login flow inside non-TTY environments." No `SUPABASE_ACCESS_TOKEN` env var set.
- **Fix:** Per plan instructions, this is a documented non-blocking gate. Continued with init and file creation. `supabase link` and `supabase db push` deferred. Created Edge Function directory/files directly instead of via `supabase functions new`.
- **Impact:** Migration files are NOT yet applied to the database. User must complete auth and push.
- **Files modified:** None (workaround, not a code fix)

## Authentication Gates

During execution, the following authentication requirement was encountered:

1. **Task 1: Supabase CLI login required**
   - `npx supabase login` fails in non-TTY CLI environment
   - `npx supabase link --project-ref <ref>` cannot run without login
   - `npx supabase db push` cannot run without link
   - **Required action:** User must run these commands manually:
     ```bash
     npx supabase login
     npx supabase link --project-ref <YOUR_PROJECT_REF>
     npx supabase db push
     ```
   - Project ref is the subdomain from your Supabase URL (e.g., `https://abcdefg.supabase.co` = ref `abcdefg`)

## Issues Encountered

**CLI auth gate (non-blocking):** Supabase CLI requires interactive browser auth or `SUPABASE_ACCESS_TOKEN`. Migration files are created and correct; they cannot be applied to the database without user completing auth. This is expected and documented in the plan.

## Next Phase Readiness

- Plan 01-02 (Edge Function scaffold/Hono): READY — `supabase/functions/qbo-api/index.ts` scaffold exists
- Plan 01-03 (OAuth flow): PENDING — Migration files need to be applied first (requires user auth gate above)
- Database schema: READY to apply (both migrations written, validated, waiting for `supabase db push`)

**Prerequisite for 01-02 and 01-03:** User must complete Supabase CLI authentication and run `npx supabase db push` before the database truths in the plan's `must_haves` are satisfied.

---
*Phase: 01-foundation*
*Completed: 2026-02-17*
